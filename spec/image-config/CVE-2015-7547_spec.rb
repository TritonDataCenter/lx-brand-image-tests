require 'spec_helper'

# Test to ensure images are not vulnerable to CVE-2015-7547
# See:
# https://googleonlinesecurity.blogspot.ca/2016/02/cve-2015-7547-glibc-getaddrinfo-stack.html
# https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-7547

# ubuntu-16.04
if property[:name] =~ /Ubuntu 16.04/
  describe command('ldd --version') do
    its(:stdout) { should contain('2.21-0ubuntu4.1') }
  end
end

# ubuntu-15.10
if property[:name] =~ /Ubuntu 15.10/
  describe command('ldd --version') do
    its(:stdout) { should contain('2.21-0ubuntu4.1') }
  end
end


# ubuntu-14.04
if property[:name] =~ /Ubuntu 14.04/
  describe command('ldd --version') do
    its(:stdout) { should contain('2.19-0ubuntu6.7') }
  end
end

if property[:name] =~ /Node\.js/
  describe command('ldd --version') do
    its(:stdout) { should contain('2.19-0ubuntu6.7') }
  end
end

# CentOS 6
if property[:name] =~ /CentOS 6./
  describe command('rpm -q --info glibc') do
    its(:stdout) { should contain('2.12') }
    its(:stdout) { should contain('1.166.el6_7.7') }
  end
end

# CentOS 7
if property[:name] =~ /CentOS 7./
  describe command('rpm -q --info glibc') do
    its(:stdout) { should contain('2.17') }
    its(:stdout) { should contain('106.el7_2.4') }
  end
end

# Debian 7
if property[:name] =~ /Debian 7./
  describe command('ldd --version') do
    its(:stdout) { should match /2.13-38\+deb7u10/ }
  end
end

# Debian 8
if property[:name] =~ /Debian 8./
  describe command('ldd --version') do
    its(:stdout) { should match /2.19-18\+deb8u4/ }
  end
end